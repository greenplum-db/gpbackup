# Greenplum Backup

gpbackup and gprestore are Go utilities for performing backups and restores of a Greenplum Database. They are still currently in active development.

## Pre-Requisites

gpbackup requires Go version 1.8 or higher.
Follow the directions [here](https://golang.org/doc/) to get the language set up.

## Downloading

```bash
go get github.com/greenplum-db/gpbackup/...
```

This will place the code in `$GOPATH/github.com/greenplum-db/gpbackup`.

## Building and installing binaries

cd into the gpbackup directory and run

```bash
make depend
make build
```

This will put the gpbackup and gprestore binaries in `$HOME/go/bin`

`make build_linux` and `make build_mac` are for cross compiling between macOS and Linux

`make install_helper` will scp the gpbackup_helper binary (used with -single-data-file flag) to all hosts

## Running the utilities

The basic command for gpbackup is
```bash
gpbackup --dbname <your_db_name>
```

The basic command for gprestore is
```bash
gprestore --timestamp <YYYYMMDDHHMMSS>
```

Run `--help` with either command for a complete list of options.

## Validation and code quality

To run all tests except end-to-end (unit, integration, and linters), use
```bash
make test
```
To run only unit tests, use
```bash
make unit
```
To run only integration tests (which require a running GPDB instance), use
```bash
make integration
```

To run end to end tests, use
```bash
make end_to_end
```

**We provide the following targets to help developers ensure their code fits Go standard formatting guidelines.**

To run a linting tool that checks for basic coding errors, use
```bash
make lint
```
This target runs [gometalinter](https://github.com/alecthomas/gometalinter).

Note: The lint target will fail if code is not formatted properly.


To automatically format your code and add/remove imports, use
```bash
make format
```
This target runs [goimports](https://godoc.org/golang.org/x/tools/cmd/goimports) and [gofmt](https://golang.org/cmd/gofmt/).
We will only accept code that has been formatted using this target or an equaivalent `gofmt` call.

## Cleaning up

To remove the compiled binaries and other generated files, run
```bash
make clean
```

## Project structure

This repository has several different packages:

### backup
Functions that are directly responsible for performing backup operations.

This package is organized by backup section:
- global
- predata
- data
- postdata

and object type:

- relations: sequences, regular tables, and views
- externals: external protocols and external tables
- types: shell, base, composite, and enum types
- functions: functions, aggregates, and casts
- operators: operators, operator classes, and operator families
- textsearch: text search parser, template, dictionary, and configuration
- shared: metadata that applies to multiple objects such as owners, comments, privileges, and constraints

### restore
Functions that are directly responsible for performing restore operations.

### utils
Functions and structs that are used by both the backup and restore packages. This includes operations such as database access, input parsing, and logging.

### integration
Integration tests run against a Greenplum Database such as queries against the catalog and SQL generated by gpbackup.

### testutils
Functions and structs that are used for testing.

### helper
This package contains the code for the gpbackup_helper agent which runs on segments and is used for the single-data-file format.

All packages have an accompanying `_test` package that contains unit tests
# How to Contribute

We accept contributions via [Github Pull requests](https://help.github.com/articles/using-pull-requests) only.

Follow the steps below to contribute to gpbackup:
1. Fork the projectâ€™s repository.
1. Run `go get github.com/greenplum-db/gpbackup/...` and add your fork as a remote.
1. Run `make depend` to install required dependencies
1. Create your own feature branch (e.g. `git checkout -b gpbackup_branch`) and make changes on this branch.
    * Follow the previous sections on this page to setup and build in your environment.
    * Add new tests to cover your code. We use [Ginkgo](http://onsi.github.io/ginkgo/) and [Gomega](https://onsi.github.io/gomega/) for testing.
1. Run `make format`, `make test`, and `make end_to_end` in your feature branch and ensure they are successful.
1. Push your local branch to the fork (e.g. `git push <your_fork> gpbackup_branch`) and [submit a pull request](https://help.github.com/articles/creating-a-pull-request).

Your contribution will be analyzed for product fit and engineering quality prior to merging.
Note: All contributions must be sent using GitHub Pull Requests.

**Your pull request is much more likely to be accepted if it is small and focused with a clear message that conveys the intent of your change.**

Overall we follow GPDB's comprehensive contribution policy. Please refer to it [here](https://github.com/greenplum-db/gpdb#contributing) for details.
